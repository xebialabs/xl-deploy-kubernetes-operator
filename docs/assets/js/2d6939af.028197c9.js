"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[926],{3905:function(e,t,a){a.d(t,{Zo:function(){return d},kt:function(){return u}});var n=a(7294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,r=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=p(a),u=l,k=c["".concat(s,".").concat(u)]||c[u]||m[u]||r;return a?n.createElement(k,o(o({ref:t},d),{},{components:a})):n.createElement(k,o({ref:t},d))}));function u(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=a.length,o=new Array(r);o[0]=c;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:l,o[1]=i;for(var p=2;p<r;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},7447:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return d},default:function(){return c}});var n=a(7462),l=a(3366),r=(a(7294),a(3905)),o=["components"],i={sidebar_position:12},s="A. How to change namespace in case there is deploy already running in the default namespace - parallel option",p={unversionedId:"manual/change-namespace-for-xld-10.3-with-parallel",id:"manual/change-namespace-for-xld-10.3-with-parallel",isDocsHomePage:!1,title:"A. How to change namespace in case there is deploy already running in the default namespace - parallel option",description:"Prerequisites",source:"@site/docs/manual/change-namespace-for-xld-10.3-with-parallel.md",sourceDirName:"manual",slug:"/manual/change-namespace-for-xld-10.3-with-parallel",permalink:"/xl-deploy-kubernetes-operator/docs/manual/change-namespace-for-xld-10.3-with-parallel",tags:[],version:"current",sidebarPosition:12,frontMatter:{sidebar_position:12},sidebar:"tutorialSidebar",previous:{title:"Setting up custom namespace",permalink:"/xl-deploy-kubernetes-operator/docs/manual/setting-up-custom-namespace"},next:{title:"B. How to change namespace in case there is deploy already running in the default namespace - with downtime",permalink:"/xl-deploy-kubernetes-operator/docs/manual/change-namespace-for-xld-10.3-with-downtime"}},d=[{value:"Prerequisites",id:"prerequisites",children:[],level:2},{value:"Steps to setup operator on the custom namespace",id:"steps-to-setup-operator-on-the-custom-namespace",children:[{value:"A.1. Create custom namespace",id:"a1-create-custom-namespace",children:[],level:3},{value:"A.2. Backup everything on cluster",id:"a2-backup-everything-on-cluster",children:[],level:3},{value:"A.3. Prepare the deploy operator",id:"a3-prepare-the-deploy-operator",children:[],level:3},{value:"A.3. Update the deploy operator package to support custom namespace (common part)",id:"a3-update-the-deploy-operator-package-to-support-custom-namespace-common-part",children:[],level:3},{value:"A.4.a. Update the deploy operator package to support custom namespace - only in case of Nginx ingress controller",id:"a4a-update-the-deploy-operator-package-to-support-custom-namespace---only-in-case-of-nginx-ingress-controller",children:[],level:3},{value:"A.4.b. Update the deploy operator package to support custom namespace - only in case of Haproxy ingress controller",id:"a4b-update-the-deploy-operator-package-to-support-custom-namespace---only-in-case-of-haproxy-ingress-controller",children:[],level:3},{value:"A.5. Update additionally YAML files",id:"a5-update-additionally-yaml-files",children:[],level:3},{value:"A.6. Be sure to not delete PVs",id:"a6-be-sure-to-not-delete-pvs",children:[],level:3},{value:"A.7. Copy existing PVCs to the custom namespace",id:"a7-copy-existing-pvcs-to-the-custom-namespace",children:[],level:3},{value:"A.7.1 Do the following changes in master PVCs",id:"a71-do-the-following-changes-in-master-pvcs",children:[],level:3},{value:"A.7.2 Do the following changes in worker PVCs",id:"a72-do-the-following-changes-in-worker-pvcs",children:[],level:3},{value:"A.8. Deploy to the custom namespace",id:"a8-deploy-to-the-custom-namespace",children:[],level:3},{value:"A.9. Apply any custom changes",id:"a9-apply-any-custom-changes",children:[],level:3},{value:"A.10. Wrap-up",id:"a10-wrap-up",children:[{value:"A.11. Destroy XLD in default namespace",id:"a11-destroy-xld-in-default-namespace",children:[],level:4}],level:3}],level:2}],m={toc:d};function c(e){var t=e.components,a=(0,l.Z)(e,o);return(0,r.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"a-how-to-change-namespace-in-case-there-is-deploy-already-running-in-the-default-namespace---parallel-option"},"A. How to change namespace in case there is deploy already running in the default namespace - parallel option"),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The kubectl command-line tool"),(0,r.kt)("li",{parentName:"ul"},"Access to a Kubernetes cluster with installed Deploy in the ",(0,r.kt)("inlineCode",{parentName:"li"},"default")," namespace")),(0,r.kt)("p",null,"Tested with:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Deploy operator 10.3.9 with external database."),(0,r.kt)("li",{parentName:"ul"},"xl-deploy 10.3.9 upgraded to 22.2.0-621.1206"),(0,r.kt)("li",{parentName:"ul"},"xl-cli 22.2.0-621.1206"),(0,r.kt)("li",{parentName:"ul"},"Aws EKS cluster")),(0,r.kt)("p",null,"If you have already setup of the XLD default namespace it is possible to move the deployment to the custom namespace. Here we will use for example\n",(0,r.kt)("inlineCode",{parentName:"p"},"nsxld"),"."),(0,r.kt)("p",null,"In the example we will use XLD 10.3 that will be upgraded to 22.2.0-621.1206 version with latest 22.2.x operator image xebialabsunsupported/deploy-operator:22.2.0-621.1206 from the\n",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/xebialabsunsupported/deploy-operator/tags"},"https://hub.docker.com/r/xebialabsunsupported/deploy-operator/tags")," and latest operator\npackage from the ",(0,r.kt)("a",{parentName:"p",href:"https://nexus.xebialabs.com/nexus/content/repositories/releases/ai/digital/deploy/operator/deploy-operator-aws-eks/22.2.0-621.1206/"},"nexus"),"."),(0,r.kt)("h2",{id:"steps-to-setup-operator-on-the-custom-namespace"},"Steps to setup operator on the custom namespace"),(0,r.kt)("p",null,"With following steps you will setup XLD in the custom namespace, in ",(0,r.kt)("strong",{parentName:"p"},"parallel")," with running current setup in the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace."),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Before doing any of the following steps backup everything:"),(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.xebialabs.com/v.22.1/deploy/concept/the-xl-deploy-work-directory/#clean-up-the-work-directory"},"Clean up deploy Work directory")),(0,r.kt)("li",{parentName:"ul"},"database data"),(0,r.kt)("li",{parentName:"ul"},"any custom configuration that was done for the operator setup"),(0,r.kt)("li",{parentName:"ul"},"any volume related to deploy in the default namespace, for example data from the mounted volumes on the master and worker pod:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/central-conf/deploy-server.yaml.template"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/centralConfiguration/deploy-oidc.yaml"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/work"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/conf"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/centralConfiguration"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/ext"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/hotfix/lib"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/hotfix/plugins"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/hotfix/satellite-lib"),(0,r.kt)("li",{parentName:"ul"},"/opt/xebialabs/xl-deploy-server/log")))))),(0,r.kt)("h3",{id:"a1-create-custom-namespace"},"A.1. Create custom namespace"),(0,r.kt)("p",null,"Setup custom namespace on Kubernetes cluster, ",(0,r.kt)("inlineCode",{parentName:"p"},"nsxld")," for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u276f kubectl create namespace nsxld\n")),(0,r.kt)("p",null,"Replace ",(0,r.kt)("inlineCode",{parentName:"p"},"nsxld")," name in this and following steps with your custom namespace name."),(0,r.kt)("h3",{id:"a2-backup-everything-on-cluster"},"A.2. Backup everything on cluster"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Collect all custom changes that are done in the ",(0,r.kt)("inlineCode",{parentName:"li"},"default")," namespace for XLD resources",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"StatefulSets"),(0,r.kt)("li",{parentName:"ul"},"Deployments"),(0,r.kt)("li",{parentName:"ul"},"ConfigMaps"),(0,r.kt)("li",{parentName:"ul"},"Secrets"),(0,r.kt)("li",{parentName:"ul"},"CustomResource"),(0,r.kt)("li",{parentName:"ul"},"anything else that was customized"))),(0,r.kt)("li",{parentName:"ol"},"Collect any other change that was done during initial setup according to the\n",(0,r.kt)("a",{parentName:"li",href:"https://docs.xebialabs.com/v.22.1/deploy/how-to/k8s-operator/install-deploy-using-k8s-operator/#installing-deploy-on-amazon-eks"},"https://docs.xebialabs.com/v.22.1/deploy/how-to/k8s-operator/install-deploy-using-k8s-operator/#installing-deploy-on-amazon-eks")),(0,r.kt)("li",{parentName:"ol"},"If you are using your own database and messaging queue setup, do the data backup.")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Note:\nAny data migration is out of scope of this document. For example in case of database data migration, check with your DB admins what to do in that case.\nFor the external database case the best option is to migrate database to a new database schema, and use that schema on the new namespace."))),(0,r.kt)("h3",{id:"a3-prepare-the-deploy-operator"},"A.3. Prepare the deploy operator"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get the deploy operator package zip for AWS-EKS: deploy-operator-aws-eks-22.2.0-621.1206.zip (correct operator image is already setup in the package).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download and set up the XL CLI setup (xl cli version in this case 22.2.0-621.1206) from ",(0,r.kt)("a",{parentName:"p",href:"https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/com/xebialabs/xlclient/xl-client/22.2.0-621.1206/xl-client-22.2.0-621.1206-linux-amd64.bin"},"https://nexus.xebialabs.com/nexus/service/local/repositories/releases/content/com/xebialabs/xlclient/xl-client/22.2.0-621.1206/xl-client-22.2.0-621.1206-linux-amd64.bin"),"\nDo the step 6 from the documentation ",(0,r.kt)("a",{parentName:"p",href:"https://docs.xebialabs.com/v.22.1/deploy/how-to/k8s-operator/install-deploy-using-k8s-operator/#step-6download-and-set-up-the-xl-cli"},"Step 6\u2014Download and set up the XL CLI")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"[sishwarya@localhost B-defaultns-downtime] $ ./xl-client-22.2.0-621.1206-linux-amd64.bin version\nCLI version:             22.2.0-621.1206\nGit version:             v22.2.0-620.544-1-g520f8bb\nAPI version XL Deploy:   xl-deploy/v1\nAPI version XL Release:  xl-release/v1\nGit commit:              520f8bbd7c61c7d11a16b677838250fa570730a2\nBuild date:              2022-06-21T11:33:41.580Z\nGO version:              go1.16\nOS/Arch:                 linux/amd64\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Do the step 7 from the documentation ",(0,r.kt)("a",{parentName:"p",href:"https://docs.xebialabs.com/v.22.1/deploy/how-to/k8s-operator/install-deploy-using-k8s-operator/#step-7set-up-the-xl-deploy-container-instance-1"},"Step 7\u2014Set up the XL Deploy Container instance"),"\nUse the 22.2.0-621.1206version of the deploy: ",(0,r.kt)("inlineCode",{parentName:"p"},'docker run -d -e "ADMIN_PASSWORD=admin" -e "ACCEPT_EULA=Y" -p 4516:4516 --name xld xebialabsunsupported/xl-deploy:22.2.0-621.1206'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Run the upgrade setup with a dry run and generate the blueprint file:"))),(0,r.kt)("p",null,"Here is sample of the responses:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'\n[sishwarya@localhost s1] $ ../../xl-client-22.2.0-621.1206-linux-amd64.bin op --upgrade --dry-run\n? Select the setup mode? advanced\n? Select the Kubernetes setup where the digitalai Devops Platform will be installed or uninstalled: AwsEKS [AWS EKS]\n? Do you want to use Kubernetes\' current-context from ~/.kube/config? Yes\n? Do you want to use the AWS SSO credentials ? No\n? Do you want to use the AWS credentials from your ~/.aws/credentials file? Yes\n? Do you want to use an custom Kubernetes namespace (current default is \'digitalai\')? Yes\n? Enter the name of the existing Kubernetes namespace where the XebiaLabs DevOps Platform will be installed, updated or undeployed: default\nConnecting to EKS\n? Product server you want to perform upgrade for daiDeploy [Digital.ai Deploy]\n? Enter the repository name(eg: <repositoryName>/<imageName>:<tagName>) xebialabsunsupported\n? Enter the deploy server image name(eg: <repositoryName>/<imageName>:<tagName>) xl-deploy\n? Enter the image tag(eg: <repositoryName>/<imageName>:<tagName>) 22.2.0-621.1206\n? Enter the deploy task engine image name for version 22 and above (eg: <repositoryName>/<imageName>:<tagName>) deploy-task-engine\n? Choose the version of the XL Deploy for Upgrader setup of operator 22.2.0-621.1206\n? Do you want to enable an oidc? Yes\n? Do you want to use an existing external oidc configuration from previous installation? No\n? Use embedded keycloak? Yes\n? Enter Keycloak public URL deploy.keycloak.digitalai-testing.com\n? Use embedded DB for keycloak? Yes\n? Select the type of upgrade you want. operatorToOperator [Operator to Operator]\n? Operator image to use xebialabsunsupported/deploy-operator:22.2.0-621.1206\n? Do you want to use custom operator zip file for Deploy? Yes\n? Deploy operator zip to use (absolute path or URL to the zip) /home/sishwarya/SprintTicket/S-84982_ns_xld_migration/B-defaultns-downtime/deploy-operator-aws-eks-22.2.0-621.1206.zip\n? Enter the name of custom resource definition. digitalaideploys.xld.digital.ai\n? Enter the name of custom resource. dai-xld\n? Edit list of custom resource keys that will migrate to the new Deploy CR <Received>\n     -------------------------------- ----------------------------------------------------\n    | LABEL                          | VALUE                                              |\n     -------------------------------- ----------------------------------------------------\n    | AWSAccessKey                   | *****                                              |\n    | AWSAccessSecret                | *****                                              |\n    | AWSSessionToken                | *****                                              |\n    | CrName                         | dai-xld                                            |\n    | CrdName                        | digitalaideploys.xld.digital.ai                    |\n    | DeployImageVersionForUpgrader  | 22.2.0-621.1206                                    |\n    | EksClusterName                 | devops-operator-cluster-test-cluster               |\n    | EnableOidc                     | true                                               |\n    | ImageNameDeploy                | xl-deploy                                          |\n    | ImageNameDeployTaskEngine      | deploy-task-engine                                 |\n    | ImageTag                       | 22.2.0-621.1206                                    |\n    | IsAwsCfgAvailable              | true                                               |\n    | K8sApiServerURL                | https://72673EC78289B3B122CAC4CA8E6473C2.gr7.us-.. |\n    | K8sSetup                       | AwsEKS                                             |\n    | KeycloakUrl                    | deploy.keycloak.digitalai-testing.com              |\n    | Namespace                      | default                                            |\n    | OperatorImageDeployGeneric     | xebialabsunsupported/deploy-operator:22.2.0-621... |\n    | OperatorZipDeploy              | /home/sishwarya/SprintTicket/S-84982_ns_xld_migr.. |\n    | OsType                         | linux                                              |\n    | PreserveCrValuesDeploy         | .metadata.name\\n.spec.XldMasterCount\\n.spec.XldW.. |\n    | RepositoryName                 | xebialabsunsupported                               |\n    | ServerType                     | daiDeploy                                          |\n    | UpgradeType                    | operatorToOperator                                 |\n    | UseAWSSsoCredentials           | false                                              |\n    | UseAWSconfig                   | true                                               |\n    | UseCustomNamespace             | true                                               |\n    | UseEmbeddedKeycloak            | true                                               |\n    | UseExistingOidcConf            | false                                              |\n    | UseKeycloakWithEmbeddedDB      | true                                               |\n    | UseKubeconfig                  | true                                               |\n    | UseOperatorZipDeploy           | true                                               |\n     -------------------------------- ----------------------------------------------------\n? Do you want to proceed to the deployment with these values? Yes\n? Current CRD resource "digitalaideploys.xld.digital.ai" is used in following CRs and namespaces:\nName      Namespace\ndai-xld   default\n\nShould CRD be reused. If Yes it will not be deleted, if No we will delete CRD "digitalaideploys.xld.digital.ai", and all related CRs will be deleted with it. Yes\nGenerated files successfully! \nUpdate central configuration values...  | Using same custom resource name dai-xld\nUpdate with keycloak values...  | Generated files successfully operatorToOperator upgrade on AwsEKS\n')),(0,r.kt)("p",null,"That will create files and directories in the working directory. The main directory is ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs")," and inside it are all template files that we need to edit.\nCheck the ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy/daideploy_cr.yaml")," if all values are correctly set there."),(0,r.kt)("h3",{id:"a3-update-the-deploy-operator-package-to-support-custom-namespace-common-part"},"A.3. Update the deploy operator package to support custom namespace (common part)"),(0,r.kt)("p",null,"Update following files (relative to the provider's directory) with custom namespace name:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"left"},"File name"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Yaml path"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Value to set"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/xl-k8s-foundation.yaml ","[kind: Infrastructure]"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec","[0]",".children","[0]",".children","[0]",".name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/xl-k8s-foundation.yaml ","[kind: Infrastructure]"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec","[0]",".children","[0]",".children","[0]",".namespaceName"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/xl-k8s-foundation.yaml ","[kind: Environments]"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec","[0]",".children","[0]",".members","[1]"),(0,r.kt)("td",{parentName:"tr",align:"left"},"- Infrastructure/DIGITALAI/K8s-MASTER/nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/cluster-role-digital-proxy-role.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-proxy-role")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/cluster-role-manager-role.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-manager-role")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/cluster-role-metrics-reader.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-metrics-reader")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/leader-election-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"subjects","[0]",".namespace"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/manager-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-manager-rolebinding")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/manager-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"roleRef.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-manager-role")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/manager-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"subjects","[0]",".namespace"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/proxy-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-proxy-rolebinding")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/proxy-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"roleRef.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld-xld-operator-proxy-role")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/proxy-rolebinding.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"subjects","[0]",".namespace"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/postgresql-init-keycloak-db.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"dai-xld-nsxld-postgresql-init-keycloak-db")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/postgresql-init-keycloak-db.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.template.metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"dai-xld-nsxld-postgresql-init-keycloak-db")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/postgresql-init-keycloak-db.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.template.spec.initContainers","[0]",".env.children","[0]",".value"),(0,r.kt)("td",{parentName:"tr",align:"left"},"dai-xld-nsxld-postgresql")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/template-generic/postgresql-init-keycloak-db.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.template.spec.containers","[0]",".children","[0]",".env.children","[0]",".value"),(0,r.kt)("td",{parentName:"tr",align:"left"},"dai-xld-nsxld-postgresql")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"metadata.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"dai-xld-nsxld")))),(0,r.kt)("p",null,"Below fields needs to be updated only when we enable keycloak with embedded database and we use existing database for deploy:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"left"},"File name"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Yaml path"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Value to set"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Note"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.keycloak.install"),(0,r.kt)("td",{parentName:"tr",align:"left"},"true"),(0,r.kt)("td",{parentName:"tr",align:"left"})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.postgresql.install"),(0,r.kt)("td",{parentName:"tr",align:"left"},"true"),(0,r.kt)("td",{parentName:"tr",align:"left"})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.postgresql.persistence.storageClass"),(0,r.kt)("td",{parentName:"tr",align:"left"},'"aws-efs"'),(0,r.kt)("td",{parentName:"tr",align:"left"},"Provide Storage Class to be defined as PostgreSQL specific to each provider, here we are using aws efs storageclass.")))),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy/template-generic/deployment.yaml")," add ",(0,r.kt)("inlineCode",{parentName:"p"},"env")," section after ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.template.spec.containers[1].image")," (in the same level) in case if it is not available:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"        image: xebialabs...\n        env:\n          - name: WATCH_NAMESPACE\n            valueFrom:\n              fieldRef:\n                fieldPath: metadata.namespace\n")),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy-operator.yaml")," delete array element from the ",(0,r.kt)("inlineCode",{parentName:"p"},"spec[0].children[0].deployables"),", where name is ",(0,r.kt)("inlineCode",{parentName:"p"},"name: custom-resource-definition")," if it is not already removed during dry-run.\nThis will not deploy again CRD, as it already exists, when it was deployed for the first time. Example of the element to delete"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'      - name: custom-resource-definition\n        type: k8s.ResourcesFile\n        fileEncodings:\n          ".+\\\\.properties": ISO-8859-1\n        mergePatchType: strategic\n        propagationPolicy: Foreground\n        updateMethod: patch\n        createOrder: "3"\n        modifyOrder: "2"\n        destroyOrder: "1"\n        file: !file "dai-deploy/template-generic/custom-resource-definition.yaml"\n')),(0,r.kt)("h3",{id:"a4a-update-the-deploy-operator-package-to-support-custom-namespace---only-in-case-of-nginx-ingress-controller"},"A.4.a. Update the deploy operator package to support custom namespace - only in case of Nginx ingress controller"),(0,r.kt)("p",null,"Following changes are in case of usage nginx ingress (default behaviour):"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"left"},"File name"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Yaml path"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Value to set"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.ingress.annotations.kubernetes.io/ingress.class"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nginx-dai-xld-nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.nginx-ingress-controller.extraArgs.ingress-class"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nginx-dai-xld-nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.nginx-ingress-controller.ingressClassResource.name"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nginx-dai-xld-nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.nginx-ingress-controller.ingressClassResource.controllerClass"),(0,r.kt)("td",{parentName:"tr",align:"left"},"k8s.io/ingress-nginx-dai-xld-nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.keycloak.ingress.annotations.kubernetes.io/ingress.class"),(0,r.kt)("td",{parentName:"tr",align:"left"},"nginx-dai-xld-nsxld")))),(0,r.kt)("h3",{id:"a4b-update-the-deploy-operator-package-to-support-custom-namespace---only-in-case-of-haproxy-ingress-controller"},"A.4.b. Update the deploy operator package to support custom namespace - only in case of Haproxy ingress controller"),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Note:\nTo setup haproxy instead of default nginx configuration that is provided in the operator package you need to do following changes in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy/daideploy_cr.yaml"),":"),(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"spec.haproxy-ingress.install = true")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"spec.nginx-ingress-controller.install = false")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'spec.ingress.path = "/"')),(0,r.kt)("li",{parentName:"ul"},"in the ",(0,r.kt)("inlineCode",{parentName:"li"},"spec.ingress.annotations")," replace all ",(0,r.kt)("inlineCode",{parentName:"li"},"nginx.")," settings and put:")),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre"},'      kubernetes.io/ingress.class: "haproxy"\n      ingress.kubernetes.io/ssl-redirect: "false"\n      ingress.kubernetes.io/rewrite-target: /\n      ingress.kubernetes.io/affinity: cookie\n      ingress.kubernetes.io/session-cookie-name: JSESSIONID\n      ingress.kubernetes.io/session-cookie-strategy: prefix\n      ingress.kubernetes.io/config-backend: |\n        option httpchk GET /ha/health HTTP/1.0\n')))),(0,r.kt)("p",null,"Following changes are in case of usage haproxy ingress:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"left"},"File name"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Yaml path"),(0,r.kt)("th",{parentName:"tr",align:"left"},"Value to set"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.ingress.annotations.kubernetes.io/ingress.class"),(0,r.kt)("td",{parentName:"tr",align:"left"},"haproxy-dai-xld-nsxld")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"xebialabs/dai-deploy/daideploy_cr.yaml"),(0,r.kt)("td",{parentName:"tr",align:"left"},"spec.haproxy-ingress.controller.ingressClass"),(0,r.kt)("td",{parentName:"tr",align:"left"},"haproxy-dai-xld-nsxld")))),(0,r.kt)("h3",{id:"a5-update-additionally-yaml-files"},"A.5. Update additionally YAML files"),(0,r.kt)("p",null,"Apply all collected changes from the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace to the CR in the deploy operator package ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy/daideploy_cr.yaml"),".\n(The best is to compare new CR ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy/daideploy_cr.yaml")," with the one from the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace)"),(0,r.kt)("p",null,"Check the YAML files, and update them with additional changes. For example CR YAML and update it with any missing custom configuration. "),(0,r.kt)("p",null,"If you are using your own database and messaging queue setup, setup it in the same way as in the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace,\nin the new CR in the deploy operator package ",(0,r.kt)("inlineCode",{parentName:"p"},"xebialabs/dai-deploy/daideploy_cr.yaml"),".\nDatabase in this case of setup can be reused if there is network visibility in the new namespace where you are moving your installation"),(0,r.kt)("p",null,"In case, During upgrade if we disabled oidc setup by answering below question "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"- Do you want to enable an oidc? No,\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"But you need to add external oidc configuration.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"For example, you can do now OIDC setup, add the following fields with value under spec tag, for enabling oidc in the ",(0,r.kt)("inlineCode",{parentName:"li"},"xebialabs/dai-deploy/daideploy_cr.yaml"))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'spec:\n  oidc:\n    enabled: true\n    accessTokenUri: null\n    clientId: null\n    clientSecret: null\n    emailClaim: null\n    external: true\n    fullNameClaim: null\n    issuer: null\n    keyRetrievalUri: null\n    logoutUri: null\n    postLogoutRedirectUri: null\n    redirectUri: null\n    rolesClaim: null\n    userAuthorizationUri: null\n    userNameClaim: null\n    scopes: ["openid"]\n')),(0,r.kt)("p",null,"Replace nulls with correct values, for more info check ",(0,r.kt)("a",{parentName:"p",href:"https://docs.xebialabs.com/v.22.1/deploy/concept/xl-deploy-oidc-authentication/"},"documentation")),(0,r.kt)("h3",{id:"a6-be-sure-to-not-delete-pvs"},"A.6. Be sure to not delete PVs"),(0,r.kt)("p",null,"Do the step from ",(0,r.kt)("a",{parentName:"p",href:"/xl-deploy-kubernetes-operator/docs/manual/move_pvc_to_other_namespace#c2-be-sure-to-not-delete-pvs-with-your-actions"},"C.2. Be sure to not delete PVs with you actions")),(0,r.kt)("h3",{id:"a7-copy-existing-pvcs-to-the-custom-namespace"},"A.7. Copy existing PVCs to the custom namespace"),(0,r.kt)("p",null,"There are 3 options from the step from ",(0,r.kt)("a",{parentName:"p",href:"/xl-deploy-kubernetes-operator/docs/manual/move_pvc_to_other_namespace#c4-move-existing-pvc-to-the-custom-namespace"},"C.4. Move existing PVC to the custom namespace"),"\nIn this scenario you can only use:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("h3",{parentName:"li",id:"c4option_1-create-pvc-in-the-custom-namespace-by-copying-pv-data"},"C.4.OPTION_1 Create PVC in the custom namespace by copying PV data")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("h3",{parentName:"li",id:"c4option_3-move-existing-pvc-to-the-custom-namespace-by-csi-volume-cloning"},"C.4.OPTION_3 Move existing PVC to the custom namespace by CSI Volume Cloning"))),(0,r.kt)("h3",{id:"a71-do-the-following-changes-in-master-pvcs"},"A.7.1 Do the following changes in master PVCs"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create the master pod in custom-namespace ","[eg: nsxld]",", similar to ",(0,r.kt)("a",{parentName:"li",href:"move_pvc_to_other_namespace#c4option_12-master---start-following-pods"},"C.4.OPTION_1.2 Master - Start following pods")," "),(0,r.kt)("li",{parentName:"ul"},"Connect to the master pod in custom-namespace.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl exec -it dai-xld-master-pv-access-nsxld -n nsxld -- sh\n"))),(0,r.kt)("li",{parentName:"ul"},"Update the following file in centralConfiguration folder.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"deploy-task.yaml.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Point it to correct rabbitmq.  ","[only required if your using embedded rabbitmq for deploy]",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"jms-url: amqp://dai-xld-nsxld-rabbitmq.nsxld.svc.cluster.local:5672/%2F",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl exec -it pod/dai-xld-master-pv-access-nsxld -n nsxld -- sh\n/ # cd opt/xebialabs/xl-deploy-server/centralConfiguration\n/opt/xebialabs/xl-deploy-server/centralConfiguration # cat deploy-task.yaml\nakka:\n  io:\n    dns:\n      resolver: async-dns\ndeploy:\n  task:\n    in-process-worker: false\n    queue:\n      archive-queue-name: xld-archive-queue\n      external:\n        jms-driver-classname: com.rabbitmq.jms.admin.RMQConnectionFactory\n        jms-password: '{cipher}9880501a40e7618fa9bb582d84e4b0e296e9f92a43deaaa4ad63bb98ab69c5b3'\n        jms-url: amqp://dai-xld-nsxld-rabbitmq.nsxld.svc.cluster.local:5672/%2F\n        jms-username: guest\n      in-process:\n        maxDiskUsage: 100\n        shutdownTimeout: 60000\n      name: xld-tasks-queue\n"))))))),(0,r.kt)("li",{parentName:"ul"},"deploy-server.yaml",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If keycloak is enabled. ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Update the property deploy.server.security.auth.provider: oidc, if required change the hostname as well.     ")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'\u276f kubectl exec -it pod/dai-xld-master-pv-access-nsxld -n nsxld -- sh\n/ # cd opt/xebialabs/xl-deploy-server/centralConfiguration\n/opt/xebialabs/xl-deploy-server/centralConfiguration # cat deploy-server.yaml \ndeploy.server:\n  hostname: dai-xld-nsxld-digitalai-deploy-master-0.dai-xld-nsxld-digitalai-deploy-master.nsxld.svc.cluster.local\n  license:\n    daysBeforeWarning: 10\n  security:\n    auth:\n      provider: "oidc"\n'))))))),(0,r.kt)("li",{parentName:"ul"},"Update the following file in conf folder.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'  * xld-wrapper.conf.common\n      * Search for jmx_prometheus_javaagent.jar and update it to "jmx_prometheus_javaagent-0.16.1.jar".\n    Note : Either update the value or delete the file [xld-wrapper.conf.common], it will be downloaded automatically with the latest changes during startup.\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl exec -it pod/dai-xld-master-pv-access-nsxld -n nsxld -- sh\n/ # cd opt/xebialabs/xl-deploy-server/conf\n/opt/xebialabs/xl-deploy-server/conf # rm -rf xld-wrapper.conf.common\n")))),(0,r.kt)("h3",{id:"a72-do-the-following-changes-in-worker-pvcs"},"A.7.2 Do the following changes in worker PVCs"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create the worker pod in custom-namespace ","[eg: nsxld]","."),(0,r.kt)("li",{parentName:"ul"},"Connect to the worker pod"),(0,r.kt)("li",{parentName:"ul"},"Update the following file in conf folder.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"xld-wrapper.conf.common"),(0,r.kt)("li",{parentName:"ul"},'Search for jmx_prometheus_javaagent.jar and update it to "jmx_prometheus_javaagent-0.16.1.jar".\nNote : Either update or delete the file ',"[xld-wrapper.conf.common]",", it will be downloaded automatically with the latest changes during startup.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"    \u276f kubectl exec -it pod/dai-xld-worker-pv-access-nsxld -n nsxld -- sh\n    / # cd /opt/xebialabs/deploy-task-engine/conf/\n    /opt/xebialabs/deploy-task-engine/conf # rm -rf xld-wrapper.conf.common\n    /opt/xebialabs/deploy-task-engine/conf #\n")))))),(0,r.kt)("h3",{id:"a8-deploy-to-the-custom-namespace"},"A.8. Deploy to the custom namespace"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"We are using here yaml that was result of the upgrade dry-run in the working directory, so we should apply against following file:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"xl apply -f ./xebialabs.yaml\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Do the step 9, 10 and 11 from the documentation ",(0,r.kt)("a",{parentName:"p",href:"https://docs.xebialabs.com/v.22.1/deploy/how-to/k8s-operator/install-deploy-using-k8s-operator/#step-10verify-if-the-deployment-was-successful-1"},"Step 9\u2014Verify the deployment status"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Troubleshooting"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If cc pod is not initialized, due to below error.")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'Type     Reason            Age                 From                    Message\n  ----     ------            ----                ----                    -------\nNormal   SuccessfulCreate  55s                 statefulset-controller  create Claim data-dir-dai-xld-nsxld-digitalai-deploy-cc-server-0 Pod dai-xld-nsxld-digitalai-deploy-cc-server-0 in StatefulSet dai-xld-nsxld-digitalai-deploy-cc-server success\nWarning  FailedCreate      34s (x13 over 55s)  statefulset-controller  create Pod dai-xld-nsxld-digitalai-deploy-cc-server-0 in StatefulSet dai-xld-nsxld-digitalai-deploy-cc-server failed error: Pod "dai-xld-nsxld-digitalai-deploy-cc-server-0" is invalid: spec.initContainers[0].volumeMounts[0].name: Not found: "source-dir"\n\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Workaround",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Edit the statefulset of dai-xld-nsxld-digitalai-deploy-cc-server")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"}," \u276f kubectl edit statefulset.apps/dai-xld-nsxld-digitalai-deploy-cc-server\n")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Update the Volume section as below.")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"    volumes:      \n     - name: source-dir\n       persistentVolumeClaim:\n         claimName: data-dir-dai-xld-nsxld-digitalai-deploy-master-0\n")))),(0,r.kt)("h3",{id:"a9-apply-any-custom-changes"},"A.9. Apply any custom changes"),(0,r.kt)("p",null,"If you have any custom changes that you collected previously in the step 3.3, you can apply them again in this step in the same way as before on the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace."),(0,r.kt)("p",null,"Check if PVCs and PVs are reused by the new setup in the custom namespace."),(0,r.kt)("h3",{id:"a10-wrap-up"},"A.10. Wrap-up"),(0,r.kt)("p",null,"Wait for all pods to ready and without any errors. "),(0,r.kt)("p",null,"If you used same host in the new custom namespace to the one that is on the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace, in that case XLD page is still opening from the ",(0,r.kt)("inlineCode",{parentName:"p"},"default"),"\nnamespace. You need in that case apply step 9.a, after that on the configurated host will be available XLD that is from the new custom namespace."),(0,r.kt)("p",null,"List of pods should look like following table, if nginx and keycloak is enabled.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"NAMESPACE\u2191           NAME                                                          READY     RESTARTS STATUS  \nnsxld         dai-xld-nsxld-digitalai-deploy-cc-server-0                        1/1     Running     0          19m\nnsxld         dai-xld-nsxld-digitalai-deploy-master-0                           1/1     Running     5          17m\nnsxld         dai-xld-nsxld-digitalai-deploy-worker-0                           1/1     Running     1          39m\nnsxld         dai-xld-nsxld-keyclo-0                                            1/1     Running     0          39m\nnsxld         dai-xld-nsxld-nginx-ingress-controller-dbb495ccc-ln52s            1/1     Running     0          39m\nnsxld         dai-xld-nsxld-nginx-ingress-controller-default-backend-54ckc2mk   1/1     Running     0          39m\nnsxld         dai-xld-nsxld-postgresql-0                                        1/1     Running     0          19m\nnsxld         dai-xld-nsxld-postgresql-init-keycloak-db-5rlpx                   0/1     Completed   0          39m\nnsxld         dai-xld-nsxld-rabbitmq-0                                          1/1     Running     0          39m\nnsxld         xld-operator-controller-manager-759cb85546-dh2n4                  2/2     Running     0          40m\n\n")),(0,r.kt)("p",null,"Table could have different entries if you haproxy or using external rabbitmq /external keycloak."),(0,r.kt)("h4",{id:"a11-destroy-xld-in-default-namespace"},"A.11. Destroy XLD in default namespace"),(0,r.kt)("p",null,"If you are sure that everything is up and running on the new custom namespace, you can destroy previous setup on the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace."),(0,r.kt)("p",null,"Do the step from ",(0,r.kt)("a",{parentName:"p",href:"/xl-deploy-kubernetes-operator/docs/manual/move_pvc_to_other_namespace#c3-stop-everything-that-is-using-xld-pvc-s-and-other-pvc-if-needed"},"C.3. Stop everything that is using XLD PVC-s")),(0,r.kt)("p",null,"Additionally, you can also cleanup any related PVC in the default namespace and PVs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"# be careful if you would like really to delete all PVC-s and related PV-s, backup before delete\n# get pvcs related to XLD on default namespace and delete them (list of the pvcs depends on what is enabled in the deployment)\n\u276f kubectl get pvc -n default\n\u276f kubectl delete -n default pvc data-dai-xld-rabbitmq-0 ...\n")),(0,r.kt)("p",null,"You can also clean up any configmaps or secrets that are in the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace and related to the XLD."),(0,r.kt)("p",null,"You also delete all PVs that were connected to the XLD installation in the default namespace, and are not migrated and used by the custom namespace."))}c.isMDXComponent=!0}}]);